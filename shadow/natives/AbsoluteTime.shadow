/**
* @author Claude Abounegm
*/
locked class shadow:natives@
	AbsoluteTime
{
	private native readonly getAbsoluteTime() => (int sec, int usec);
	private native readonly setAbsoluteTime(Pointer time, int sec, int nsec) => ();
	
	private native readonly get handleSize() => (int);
	
	Handle handle;
	
	public create(TimeSpan ts)
	{
		handle = Handle:create(this->handleSize);
		addTimeToNow(ts);
	}
	
	public addTimeToNow(TimeSpan ts) => ()
	{
		if(!handle->isValid) {
			throw InvalidOperationException:create("This AbsoluteTime is no longer valid.");
		}
		
		(int absSec, int absUSec) = getAbsoluteTime();
		
		int sec = absSec + ts->sec;
		int nsec = absUSec * 1000 + ts->nsec;
		
		if(nsec >= 1000000000) {
			nsec -= 1000000000;
			sec += 1;
		}
		
		setAbsoluteTime(handle->ptr, sec, nsec);
	}
	
	public readonly get ptr() => (Pointer ptr) {
		return handle->ptr;
	}
	
	public free() => ()
	{
		if(handle->isValid) {
			handle.free();
		}
	}
}